<div align="center">
  <h1 align="center">üöÄ Cybertemp SMTP Server</h1>
  <p align="center">
    A high-performance, production-ready SMTP receive-only server powering Cybertemp's temporary and private email infrastructure. Built with Rust for speed, reliability, and concurrency.
    <br />
    <br />
    <a href="https://discord.cyberious.xyz">üí¨ Discord</a>
    ¬∑
    <a href="#-changelog">üìú ChangeLog</a>
    ¬∑
    <a href="https://github.com/sexfrance/smtp-server/issues">‚ö†Ô∏è Report Bug</a>
    ¬∑
    <a href="https://github.com/sexfrance/smtp-server/issues">üí° Request Feature</a>
  </p>
</div>

---

## üìñ Table of Contents

- [About](#-about)
- [Architecture](#Ô∏è-architecture)
- [Features](#-features)
- [Prerequisites](#-prerequisites)
- [Installation](#Ô∏è-installation)
- [Configuration](#-configuration)
- [Database Setup](#-database-setup)
- [Running the Server](#-running-the-server)
- [How It Works](#-how-it-works)
- [Important Notes](#-important-notes)
- [Troubleshooting](#-troubleshooting)
- [Development Status](#-development-status)
- [ChangeLog](#-changelog)

---

## üìö About

**THIS README IS ENTIRLY GENERATED BY AI I DID NOT WRITE THIS SHIT**

**This is the actual SMTP server currently powering [Cybertemp](https://cybertemp.xyz)** - a temporary email service handling thousands of emails daily. The codebase is functional and battle-tested in production, though the code quality could use some refactoring (it works, but it's a bit messy ).

This server is designed as a **receive-only SMTP server** that:

- Accepts incoming emails on port 25 (or custom port)
- Stores temporary emails in PostgreSQL
- Manages inboxes in PostgreSQL (self-hosted)
- Supports private email accounts (optional feature used by Cybertemp)
- Implements domain whitelisting and email/domain banning (optional Supabase integration)
- Handles concurrent connections efficiently with Tokio async runtime

---

## üèóÔ∏è Architecture

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Incoming SMTP  ‚îÇ
‚îÇ   Port 25/2525  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Rust SMTP Server (Tokio)      ‚îÇ
‚îÇ  - Concurrent connection handler ‚îÇ
‚îÇ  - Email parsing (mailparse)     ‚îÇ
‚îÇ  - Domain whitelist checking     ‚îÇ
‚îÇ  - Ban list filtering            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚ñº                 ‚ñº                ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   PostgreSQL    ‚îÇ ‚îÇ   PostgreSQL ‚îÇ ‚îÇ  Heartbeat   ‚îÇ
‚îÇ  (Temp Emails)  ‚îÇ ‚îÇ   (Inboxes)  ‚îÇ ‚îÇ  Monitoring  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üî• Features

- ‚úÖ **Production-Ready**: Currently handling Cybertemp's email traffic
- ‚úÖ **High Performance**: Async Rust with Tokio for concurrent connections and super fast
- ‚úÖ **Batch Email Processing**: Emails buffered and inserted in multi-row batches for optimal database throughput
- ‚úÖ **Dual Email System**: Supports both temporary and private emails
- ‚úÖ **Domain Whitelisting**: Accept emails only for configured domains
- ‚úÖ **Ban System**: Block emails from specific senders/domains
- ‚úÖ **MIME Parsing**: Proper handling of plain text and HTML emails
- ‚úÖ **PostgreSQL Storage**: Reliable email storage with indexing
- ‚úÖ **Self-hosted Inboxes**: Automatic inbox management in PostgreSQL
- ‚úÖ **Connection Pooling**: Efficient database connections
- ‚úÖ **Queue Management**: Prevents server overload with request limits
- ‚úÖ **Heartbeat Monitoring**: Optional uptime monitoring endpoint
- ‚úÖ **Real-time Domain Updates**: Polls for domain/ban updates every 60-120s
- ‚úÖ **Graceful Error Handling**: Detailed logging with tracing

---

## üìã Prerequisites

- **Rust** 1.70+ (for compilation)
- **PostgreSQL** 12+ (for email storage and inbox management)
- **Linux/Windows/macOS** (any platform supporting Rust)
- **Port 25 Access** (or alternative SMTP port - requires root/admin on Linux for port 25)

---

## ‚öôÔ∏è Installation

### Using Rust (Recommended - Active Development)

> ‚ö†Ô∏è **Note**: The JavaScript version is **NOT MAINTAINED**. Use the Rust implementation in the `rust/` directory.

1. **Install Rust** (if not already installed):

   ```bash
   # Linux/macOS
   curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh

   # Windows
   # Download from https://rustup.rs/
   ```

2. **Clone the repository**:

   ```bash
   git clone https://github.com/sexfrance/smtp-server.git
   cd smtp-server/rust
   ```

3. **Build the project**:

   ```bash
   # Development build
   cargo build

   # Production build (optimized)
   cargo build --release
   ```

---

## üîß Configuration

Create a `.env` file in the `rust/` directory with the following variables:

```env
# PostgreSQL Database (REQUIRED)
DATABASE_URL=postgresql://username:password@localhost:5432/cybertemp

# SMTP Server Settings (OPTIONAL)
SMTP_RECEIVE_PORT=25                    # Default: 25 (use 2525 for non-root testing)

# Heartbeat Monitoring (OPTIONAL)
HEARTBEAT_URL=https://your-monitoring-service.com/ping
```

### Environment Variables Explained

| Variable               | Required | Default | Description                                     |
| ---------------------- | -------- | ------- | ----------------------------------------------- |
| `DATABASE_URL`         | ‚úÖ Yes   | -       | PostgreSQL connection string for storing emails |
| `SMTP_RECEIVE_PORT`    | ‚ùå No    | 25      | SMTP port (default: 25)                         |
| `HEARTBEAT_URL`        | ‚ùå No    | -       | Uptime monitoring ping URL                      |
| `USE_SUPABASE_BANS`    | ‚ùå No    | true    | Enable/disable Supabase ban system              |
| `USE_SUPABASE_DOMAINS` | ‚ùå No    | true    | Enable/disable Supabase domain whitelist        |

---

## üíæ Database Setup

### PostgreSQL Schema

Run the SQL schema located in `rust/SQL/schema.sql`:

```bash
psql -U your_user -d cybertemp -f rust/SQL/schema.sql
```

This creates:

- `emails` table - stores all temporary emails
- `inbox` table - stores inbox information (self-hosted)
- `private_email` table - optional private email accounts (see below)
- Necessary indexes for performance

### Optional Supabase Tables (for advanced features)

If you want to use domain whitelisting and ban management, create these tables in Supabase:

#### 1. `domains` table (Domain Whitelist - Optional)

```sql
CREATE TABLE domains (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  domain TEXT NOT NULL UNIQUE,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Add your domains
INSERT INTO domains (domain) VALUES
  ('cybertemp.xyz'),
  ('temp-mail.xyz'),
  ('*.example.com');  -- Wildcard support
```

#### 2. `bans` table (Email/Domain Blocking - Optional)

```sql
CREATE TABLE bans (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  scope TEXT NOT NULL,           -- 'email' or 'domain'
  value TEXT NOT NULL,            -- email address or domain
  match_type TEXT DEFAULT 'exact', -- 'exact' or 'contains'
  status TEXT DEFAULT 'active',   -- 'active' or 'inactive'
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Example bans
INSERT INTO bans (scope, value, match_type, status) VALUES
  ('email', 'spam@example.com', 'exact', 'active'),
  ('email', 'spam', 'contains', 'active'),  -- Blocks any email containing "spam"
  ('domain', 'spammer.com', 'exact', 'active');
```

**Note**: If you don't create these Supabase tables, set `USE_SUPABASE_BANS=false` and `USE_SUPABASE_DOMAINS=false` in your `.env` file. The server will accept all domains and have no bans by default.

---

## üöÄ Running the Server

### Development Mode

```bash
cd rust
cargo run
```

### Production Mode

```bash
cd rust
cargo build --release
./target/release/cybertemp_smtp
```

### Running on Port 25 (Linux)

Port 25 requires root privileges:

```bash
# Option 1: Run as root
sudo ./target/release/cybertemp_smtp

# Option 2: Grant port binding capability (recommended)
sudo setcap CAP_NET_BIND_SERVICE=+eip ./target/release/cybertemp_smtp
./target/release/cybertemp_smtp
```

### Running as a Service (Systemd)

Create `/etc/systemd/system/cybertemp-smtp.service`:

```ini
[Unit]
Description=Cybertemp SMTP Server
After=network.target postgresql.service

[Service]
Type=simple
User=your-user
WorkingDirectory=/path/to/smtp-server/rust
EnvironmentFile=/path/to/smtp-server/rust/.env
ExecStart=/path/to/smtp-server/rust/target/release/cybertemp_smtp
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

Enable and start:

```bash
sudo systemctl daemon-reload
sudo systemctl enable cybertemp-smtp
sudo systemctl start cybertemp-smtp
sudo systemctl status cybertemp-smtp
```

---

## üîç How It Works

### Email Flow

1. **Connection**: External SMTP server connects to port 25
2. **SMTP Handshake**: Server responds with `220 Cybertemp Mail Receiver`
3. **Domain Check**: Recipient domain is validated against whitelist
4. **Ban Check**: Sender and domain are checked against ban list
5. **Email Receipt**: Server accepts email data until `.` terminator
6. **Parsing**: Email is parsed using `mailparse` crate in parallel with inbox creation
7. **Batch Queueing**: Email is queued to batch processor via channel (mpsc)
8. **Batch Processing**: When buffer reaches 50 emails or 500ms timeout, all emails are inserted in a single multi-row INSERT statement via transaction
9. **Storage Decision**:
   - If recipient is in `private_email` table ‚Üí Store in PostgreSQL `emails` table
   - Otherwise ‚Üí Store in PostgreSQL as temporary email + create PostgreSQL inbox entry
10. **Response**: Server responds with `250 Ok: Message accepted` (immediately, doesn't wait for DB batch commit)

### Domain Whitelisting

The server **only accepts emails** for domains listed in the configured domain source (Supabase `domains` table if enabled, otherwise accepts all domains). This prevents abuse and unauthorized usage.

**Wildcard support**:

- `example.com` - matches exactly `example.com`
- `*.example.com` - matches `mail.example.com`, `temp.example.com`, etc.

**Automatic updates**: Domain list is refreshed every 60 seconds.

### Ban System

Protects against spam and abuse:

- **Email bans**: Block specific sender addresses
  - `exact` match: Must match exactly
  - `contains` match: Blocks if sender contains substring
- **Domain bans**: Block entire sending domains
- **Real-time updates**: Ban list refreshes every 60 seconds

---

## ‚ö†Ô∏è Important Notes

### About Private Emails (`privatemail.sql`)

‚ö†Ô∏è **The `private_email` table is ONLY used by Cybertemp for paid features and is NOT required for basic SMTP functionality.**

**What it does**:

- Allows specific email addresses to have persistent storage
- Adds an extra layer of security with passwords
- Used for Cybertemp's paid private email accounts
- Completely optional for self-hosted deployments

**How to remove it**:

1. Delete or ignore `rust/SQL/privatemail.sql`
2. Remove the private email check in `main.rs` (lines ~409-447):
   ```rust
   // Remove this entire block:
   match sqlx::query("SELECT id FROM private_email WHERE email = $1 LIMIT 1")
       .bind(&recipient_email)
       .fetch_optional(postgres_pool)
       .await
   {
       // ... entire private email handling logic
   }
   ```

### Code Quality Disclaimer

‚ö†Ô∏è **This codebase is functional but not prettily written.** It's a working production system that evolved organically. Known issues:

- Long functions that should be split up
- Some error handling could be more elegant
- Duplicate code in fallback paths
- Comment clutter from debugging sessions

**But it works reliably** and handles thousands of emails daily for Cybertemp. Refactoring PRs welcome! üòÑ

### JavaScript Version

‚ö†Ô∏è **The `javascript/` folder is NOT MAINTAINED** - it was an early prototype. Use the Rust version for all deployments.

---

## üõ†Ô∏è Troubleshooting

### Common Issues

#### 1. "mismatched types - expected &str, found &Result<String, VarError>"

**Problem**: Environment variable not being unwrapped properly.

**Solution**: Make sure `.env` file exists and contains required variables. The error occurs when `env::var()` fails.

```rust
// Fix by adding .expect() or ?
let database_url = env::var("DATABASE_URL")
    .expect("DATABASE_URL must be set in .env file");
```

#### 2. "Failed to connect to PostgreSQL"

**Check**:

- PostgreSQL is running: `systemctl status postgresql`
- Database exists: `psql -l | grep cybertemp`
- Credentials are correct in `DATABASE_URL`
- Schema is initialized: `psql -d cybertemp -c "\dt"`

#### 3. "Failed to load domains from Supabase" (if using Supabase features)

**Check**:

- Supabase URL is correct (https://your-project.supabase.co)
- Service role key is correct (NOT anon key)
- `domains` table exists in Supabase
- Network connectivity to Supabase

#### 4. "Permission denied" binding to port 25

**Solution**:

```bash
# Option 1: Run as root
sudo ./target/release/cybertemp_smtp

# Option 2: Grant capability (Linux only)
sudo setcap CAP_NET_BIND_SERVICE=+eip ./target/release/cybertemp_smtp

# Option 3: Use alternative port
SMTP_RECEIVE_PORT=2525 ./target/release/cybertemp_smtp
```

#### 5. Emails not appearing in database

**Check logs for**:

- Domain whitelist rejections
- Ban list rejections
- Database insertion errors
- Parsing errors

**Enable debug logging**:

```bash
RUST_LOG=debug ./target/release/cybertemp_smtp
```

---

## üìä Development Status

| Component                     | Status               | Notes                                 |
| ----------------------------- | -------------------- | ------------------------------------- |
| **Rust Implementation**       | ‚úÖ **Active**        | Production-ready, actively maintained |
| **JavaScript Implementation** | ‚ùå **Abandoned**     | Not maintained, use Rust version      |
| **PostgreSQL Storage**        | ‚úÖ Production        | Stable and tested                     |
| **Self-hosted Inboxes**       | ‚úÖ Production        | No external dependencies              |
| **Supabase Integration**      | ‚ö†Ô∏è Optional          | For advanced features only            |
| **Private Email Feature**     | ‚ö†Ô∏è Optional          | Cybertemp-specific, not required      |
| **Code Quality**              | ‚ö†Ô∏è Needs Refactoring | Works but messy                       |
| **Documentation**             | ‚úÖ Complete          | You're reading it!                    |

---

## üìú ChangeLog

```diff
v0.4.0 ‚ãÆ 02/02/2025
+ Batch insert optimization with multi-row INSERT statements
+ Channel-based email buffering (mpsc) for SMTP-DB decoupling
+ TCP_NODELAY enabled for faster socket communication
+ Reduced polling intervals (domain: 120s, bans: 60s)
+ QueryBuilder for efficient bulk inserts with transactions
+ Performance optimized for 1 vCore servers

v0.3.0 ‚ãÆ 11/01/2025
+ Comprehensive documentation rewrite
+ Clarified private email feature is optional
+ Added extensive troubleshooting guide
+ Documented Supabase table schemas
+ Added systemd service configuration

v0.2.0 ‚ãÆ 09/2024
+ Ban system implementation (email/domain blocking)
+ Real-time domain whitelist updates
+ Improved MIME parsing with fallbacks
+ Connection queue management
+ Heartbeat monitoring support

v0.1.0 ‚ãÆ 06/2024
! Initial production deployment for Cybertemp
+ PostgreSQL storage implementation
+ Supabase integration
+ Domain whitelisting
+ Private email support
+ Async Tokio runtime
```

---

## üìû Support

- **Discord**: [discord.cyberious.xyz](https://discord.cyberious.xyz)
- **Email**: support@cybertemp.xyz
- **Issues**: [GitHub Issues](https://github.com/sexfrance/smtp-server/issues)

---

## üìÑ License

MIT License - See LICENSE file for details

---

## üôè Acknowledgments

- Built with ‚ù§Ô∏è for the Cybertemp community
- Powered by Rust ü¶Ä, Tokio, and PostgreSQL
- Optional Supabase integration for advanced features

---

<p align="center">
  <img src="https://img.shields.io/badge/Rust-000000?style=for-the-badge&logo=rust&logoColor=white"/>
  <img src="https://img.shields.io/badge/PostgreSQL-316192?style=for-the-badge&logo=postgresql&logoColor=white"/>
  <img src="https://img.shields.io/badge/Supabase-181818?style=for-the-badge&logo=supabase&logoColor=white"/>
  <img src="https://img.shields.io/badge/Self--Hosted-Ready-success?style=for-the-badge"/>
</p>

<div align="center">
  <strong>‚≠ê Star this repo if you found it helpful!</strong>
  <br />
  <sub>Currently powering Cybertemp's email infrastructure üöÄ</sub>
</div>
